# Полное описание системы автоматической коррекции сайтов

## Обзор системы

Система автоматической коррекции сайтов представляет собой комплексное решение для автоматического исправления HTML кода страниц на основе Astro с использованием нейросетевой детекции объектов и искусственного интеллекта для коррекции кода.

## Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                    Клиентское приложение                      │
│              (Отправка JSON запроса с Astro кодом)           │
└───────────────────────────┬─────────────────────────────────┘
                             │
                             │ HTTP POST /api/v1/correct
                             │
┌───────────────────────────▼─────────────────────────────────┐
│                    FastAPI REST API Server                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Endpoint: POST /api/v1/correct                     │   │
│  │  - Валидация запроса                                │   │
│  │  - Обработка Astro кода                             │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   Шаг 1:     │    │   Шаг 2:     │    │   Шаг 3:     │
│  Генерация   │    │  Детекция     │    │  Коррекция   │
│  скриншота   │    │  объектов     │    │  кода        │
│              │    │               │    │              │
│ (Headless    │    │ Detectron2    │    │ ChatGPT API  │
│  Browser)    │    │ Inference     │    │              │
└──────────────┘    └──────────────┘    └──────────────┘
                             │                    │
                             └────────┬───────────┘
                                      │
                             ┌────────▼──────────┐
                             │   Шаг 4:          │
                             │   Формирование    │
                             │   ответа          │
                             └────────┬──────────┘
                                      │
                             ┌────────▼──────────┐
                             │   Возврат         │
                             │   исправленного   │
                             │   Astro кода      │
                             └───────────────────┘
```

## Компоненты системы

### 1. API Server (FastAPI)

**Файл:** `app/main.py`, `app/api/routes.py`

**Функциональность:**
- Прием HTTP запросов с Astro кодом
- Валидация входных данных через Pydantic
- Координация работы всех сервисов
- Обработка ошибок и возврат ответов

**Endpoints:**
- `POST /api/v1/correct` - Основной endpoint для коррекции кода
- `GET /api/v1/health` - Проверка работоспособности
- `POST /api/v1/detect` - Только детекция объектов (без коррекции)

### 2. Inference Service (Detectron2)

**Файл:** `app/services/inference.py`

**Функциональность:**
- Загрузка обученной модели Detectron2
- Выполнение детекции объектов на скриншотах страниц
- Обнаружение перекрытий между объектами (IoU)
- Извлечение координат bounding boxes
- Определение размеров изображения

**Входные данные:**
- Путь к изображению (скриншот страницы)

**Выходные данные:**
- Количество обнаруженных объектов
- Координаты каждого объекта (x1, y1, x2, y2)
- Размеры объектов
- Уровень уверенности (confidence score)
- Информация о перекрытиях

### 3. OpenRouter Service (LLM)

**Файл:** `app/services/chatgpt.py`

**Функциональность:**
- Интеграция с OpenRouter API (поддерживает различные LLM модели)
- Формирование промптов для коррекции кода
- Автоматическое исправление координат блоков
- Конвертация пикселей в viewport единицы (vw/vh)
- Сохранение существующих блоков (опционально)

**Процесс работы:**
1. Получение исходного Astro кода
2. Получение результатов детекции
3. Формирование детального промпта с инструкциями
4. Отправка запроса в ChatGPT API
5. Получение исправленного кода
6. Извлечение информации о примененных исправлениях

### 4. HTML Parser Utilities

**Файл:** `app/utils/html_parser.py`

**Функциональность:**
- Парсинг HTML кода
- Извлечение блоков с классом 'block'
- Парсинг CSS стилей
- Обновление координат блоков
- Конвертация координат из пикселей в vw/vh

## Процесс работы системы

### Шаг 1: Получение запроса

Клиент отправляет JSON запрос:
```json
{
  "astro_code": "<html>...</html>",
  "page_id": "page_1",
  "options": {
    "confidence_threshold": 0.5,
    "preserve_blocks": true
  }
}
```

### Шаг 2: Генерация скриншота

**Текущая реализация:** Использует существующее изображение из `data/images/page_1.png`

**Планируемое улучшение:** Интеграция с headless браузером (Playwright/Selenium) для автоматической генерации скриншотов из HTML кода.

### Шаг 3: Детекция объектов

Inference Service выполняет детекцию:
- Загружает изображение
- Прогоняет через обученную модель Detectron2
- Извлекает координаты всех обнаруженных объектов
- Определяет перекрытия между объектами
- Возвращает структурированные данные

**Пример результата:**
```json
{
  "total_objects": 22,
  "overlaps": 0,
  "objects": [
    {
      "id": 0,
      "score": 0.999,
      "bbox": [194.0, 1779.0, 388.0, 1889.0],
      "bbox_size": [194.0, 110.0],
      "mask_area": 20858
    }
  ],
  "image_size": [390, 2532]
}
```

### Шаг 4: Коррекция кода через OpenRouter (LLM)

OpenRouter Service:
1. Формирует детальный промпт с:
   - Исходным HTML кодом
   - Данными детекции (координаты всех объектов)
   - Размером изображения
   - Инструкциями по конвертации координат
   - Требованием сохранить существующие блоки

2. Отправляет запрос в OpenRouter API (который поддерживает различные LLM модели)

3. Получает исправленный код с обновленными координатами

**Пример промпта:**
```
Исправь HTML код страницы на основе данных детекции объектов.

Исходный код: <html>...</html>

Данные детекции:
- Всего объектов: 22
- Размер изображения: 390x2532 пикселей

Объекты:
Объект 0: BBox=[194.0, 1779.0, 388.0, 1889.0], Размер=194.0x110.0px

Инструкции:
1. Обнови координаты всех блоков с классом 'block'
2. Конвертируй координаты из пикселей в vw/vh единицы
3. Сохрани все существующие блоки
...
```

### Шаг 5: Формирование ответа

API формирует ответ:
```json
{
  "status": "success",
  "corrected_code": "<html>...</html>",
  "detections": {
    "total_objects": 22,
    "overlaps": 0
  },
  "corrections_applied": [
    "Updated block coordinates",
    "Converted pixels to viewport units"
  ]
}
```

## Технические детали

### Конвертация координат

Система конвертирует координаты из пикселей в viewport единицы:

```python
left_vw = (x1 / img_width) * 100
top_vh = (y1 / img_height) * 100
width_vw = ((x2 - x1) / img_width) * 100
height_vh = ((y2 - y1) / img_height) * 100
```

Где:
- `x1, y1` - левый верхний угол bounding box в пикселях
- `x2, y2` - правый нижний угол bounding box в пикселях
- `img_width, img_height` - размер изображения в пикселях

### Обнаружение перекрытий

Система использует Intersection over Union (IoU) для обнаружения перекрытий:

```python
IoU = intersection_area / union_area
```

Если IoU >= threshold (по умолчанию 0.1), объекты считаются перекрывающимися.

### Сохранение блоков

При установке `preserve_blocks: true`:
- Все существующие блоки сохраняются
- Обновляются только координаты (top, left, width, height)
- Добавляются новые блоки для дополнительных обнаруженных объектов

## Развертывание

### Docker контейнеризация

Система полностью контейнеризована через Docker:

**Dockerfile:**
- Базовый образ: Python 3.10-slim
- Установка системных зависимостей
- Установка Python пакетов (включая Detectron2)
- Настройка рабочей директории
- Экспозиция порта 8000

**docker-compose.yml:**
- Определение сервиса API
- Настройка volumes для моделей и данных
- Настройка переменных окружения
- Health checks
- Автоматический перезапуск

### Переменные окружения

Ключевые переменные:
- `OPENAI_API_KEY` - API ключ OpenAI
- `MODEL_PATH` - Путь к модели Detectron2
- `CONFIG_PATH` - Путь к конфигурации модели
- `API_PORT` - Порт API сервера

## Безопасность

1. **API ключи:** Хранятся в переменных окружения, не коммитятся в git
2. **Валидация:** Все входные данные валидируются через Pydantic
3. **Обработка ошибок:** Централизованная обработка исключений
4. **CORS:** Настраиваемые правила CORS для защиты от несанкционированного доступа

## Масштабирование

### Горизонтальное масштабирование

Система может быть масштабирована через:
- Docker Swarm
- Kubernetes
- Load balancer (nginx, HAProxy)

### Вертикальное масштабирование

Для увеличения производительности:
- Использование GPU (CUDA) для детекции
- Кеширование результатов через Redis
- Асинхронная обработка запросов

## Мониторинг

- Health check endpoint для проверки работоспособности
- Логирование всех запросов и ошибок
- Метрики производительности (можно добавить Prometheus)

## Ограничения и будущие улучшения

### Текущие ограничения

1. **Скриншоты:** Используются существующие изображения, нет автоматической генерации
2. **Однопоточность:** Обработка запросов последовательная
3. **Нет кеширования:** Каждый запрос обрабатывается заново

### Планируемые улучшения

1. **Headless Browser:** Интеграция Playwright для генерации скриншотов
2. **Асинхронная обработка:** Celery для фоновых задач
3. **Кеширование:** Redis для кеширования результатов
4. **WebSocket:** Real-time обновления статуса обработки
5. **Batch processing:** Обработка нескольких страниц одновременно

## Использование

### Базовый пример

```python
import requests

response = requests.post(
    "http://your-server:8000/api/v1/correct",
    json={
        "astro_code": "<html>...</html>",
        "page_id": "page_1"
    }
)

result = response.json()
print(result["corrected_code"])
```

Подробные примеры см. в `API_EXAMPLES.md`.

## Заключение

Система представляет собой полноценное решение для автоматической коррекции сайтов, объединяющее:
- Современные технологии машинного обучения (Detectron2)
- Искусственный интеллект для обработки кода (через OpenRouter API, поддерживает различные LLM модели)
- Современный веб-фреймворк (FastAPI)
- Контейнеризацию для простого развертывания (Docker)

Система готова к развертыванию на сервере со статическим IP и может быть легко масштабирована для обработки больших объемов запросов.
